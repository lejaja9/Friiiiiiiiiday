import requests
import base64
from ClientId import *

class song_rec:
    """A class that holds song features, activity features, genre and returns recommendations. Taken from the Spotify API."""

    def __init__(self, song_link, activity, time_of_day, genre):
        #initial information
        self.song_link = song_link
        self.activity = activity
        self.time_of_day = time_of_day
        self.genre = genre
        
        #parameters for GET
        self.artist_ID = None
        self.song_ID = None
        self.Night = {'acousticness': [0.051187302142530616, 0.2629954578833173, 0.5443586449949921, 0.8563105017492848], 'danceability': [0.28877092078723754, 0.527265145305271, 0.6994024737246376, 0.8441108936258267], 'energy': [0.14940366340223243, 0.4124318215497712, 0.5785720743553215, 0.7222509557052426, 0.8803082618937121], 'instrumentalness': [0.003154300485407463, 0.2800824849090645, 0.6309798578738262, 0.8978986216778286], 'liveness': [0.116978890214073, 0.329885867067773, 0.7033096435947523], 'loudness': [-30.64137521831628, -15.603954342871656, -8.693378697200863, -5.07960733626369], 'speechiness': [0.052176478894036496, 0.15368064548654295, 0.2870441191527784, 0.4474271751216467, 0.8835541269156066], 'tempo': [86.37858981732701, 118.81463727274055, 143.33951924769767, 171.02900275713338], 'valence': [0.1579563989441452, 0.3605310706961407, 0.5629927991264553, 0.8029163276483204]}
        self.Late = {'acousticness': [0.049949809712140913, 0.2633791209558357, 0.5370881542725334, 0.8437265006779745], 'danceability': [0.30523346735915535, 0.5302268567772025, 0.6971927179149737, 0.8420220511657784], 'energy': [0.1766360412743842, 0.4238905846017494, 0.5836049504130567, 0.725879848802168, 0.8823919712703309], 'instrumentalness': [0.00225718255117819, 0.20891297588059077, 0.534670951603013, 0.8806990178231385], 'liveness': [0.11627824550612773, 0.32849533114432083, 0.7051570025811635], 'loudness': [-28.98505860960978, -13.678014284931066, -8.156734747732266, -4.861113304031446], 'speechiness': [0.05143700109738447, 0.15243304211029943, 0.2858496263701379, 0.4464795422816943, 0.8824409548557065], 'tempo': [87.05773335178053, 118.54010041826814, 143.32254832967857, 171.47923963932607], 'valence': [0.16383742654916816, 0.36601329166123503, 0.5694534485407704, 0.8132943239116329]}
        self.Morning = {'acousticness': [0.05012978727729375, 0.26120192800380654, 0.5342786002849637, 0.8259961144478494], 'danceability': [0.35734433017038253, 0.550163883097234, 0.7037432928412931, 0.844481871770063], 'energy': [0.2278616062629496, 0.43661975426687616, 0.5870700648181575, 0.7247772182400434, 0.8771603576284381], 'instrumentalness': [0.002346945847100955, 0.21106105773388428, 0.5357265445356565, 0.8620154236919395], 'liveness': [0.11543620966331332, 0.3241461338729708, 0.6890639680896798], 'loudness': [-21.6538578554387, -11.768035238216033, -7.593397979955599, -4.681693120411834], 'speechiness': [0.050225236591527625, 0.14987548286751498, 0.2840914225122377, 0.44561481656521973, 0.8603198966542281], 'tempo': [88.1003960746221, 118.3973036567697, 143.29661575678807, 171.7191445745569], 'valence': [0.17831237255191656, 0.376512023338647, 0.5787601397253872, 0.8178244659412188]}
        self.Afternoon = {'acousticness': [0.050490359061721196, 0.26284748726402657, 0.5361432660991571, 0.8293365253027448], 'danceability': [0.3645331250385326, 0.5549705897000081, 0.7115274552461305, 0.8525255532474758], 'energy': [0.22170085305720916, 0.4345205314016501, 0.5864102592476328, 0.7252673337673063, 0.8772012590621703], 'instrumentalness': [0.002303065143175055, 0.2045831396598907, 0.523255839818788, 0.8566194039653546], 'liveness': [0.11571788233010737, 0.3247771442018822, 0.6880205858291473], 'loudness': [-22.858784742387314, -12.036591650596531, -7.734759920598487, -4.756980275230353], 'speechiness': [0.051331957540559595, 0.1529872791968842, 0.28566529769478033, 0.447316131793282, 0.8554854992562926], 'tempo': [88.128062894798, 118.80760057100012, 143.48446847875817, 171.29537448764688], 'valence': [0.1754206016542743, 0.36800937108790005, 0.5688401346289101, 0.8085758968840702]}
        self.Evening = {'acousticness': [0.051187302142530616, 0.2629954578833173, 0.5443586449949921, 0.8563105017492848], 'danceability': [0.28877092078723754, 0.527265145305271, 0.6994024737246376, 0.8441108936258267], 'energy': [0.14940366340223243, 0.4124318215497712, 0.5785720743553215, 0.7222509557052426, 0.8803082618937121], 'instrumentalness': [0.003154300485407463, 0.2800824849090645, 0.6309798578738262, 0.8978986216778286], 'liveness': [0.116978890214073, 0.329885867067773, 0.7033096435947523], 'loudness': [-30.64137521831628, -15.603954342871656, -8.693378697200863, -5.07960733626369], 'speechiness': [0.052176478894036496, 0.15368064548654295, 0.2870441191527784, 0.4474271751216467, 0.8835541269156066], 'tempo': [86.37858981732701, 118.81463727274055, 143.33951924769767, 171.02900275713338], 'valence': [0.1579563989441452, 0.3605310706961407, 0.5629927991264553, 0.8029163276483204]}


    def get_song_ID(self):
        start = str(self.song_link).find('track/') + 6
        end = str(self.song_link).find('?')
        ID = str(self.song_link)[start:end]
        self.song_ID = ID
        return ID

    def get_song_artist(self):
        token_url = "https://accounts.spotify.com/api/token"
        #method = "POST"

        token_header = {}
        token_data = {}

        message = f"{Client_ID}:{Client_Secret}"
        message64 = base64.b64encode(message.encode())

        token_header['Authorization'] = f"Basic {message64.decode()}"

        token_data['grant_type'] = "client_credentials"

        r = requests.post(token_url, headers = token_header, data = token_data)
        token = r.json()['access_token']

        song_id = self.get_song_ID() #input
        song_url = f"https://api.spotify.com/v1/tracks/{song_id}"
        token_header = {
            "Authorization": "Bearer " + token
        }

        res = requests.get(url = song_url, headers = token_header)
        self.artist_ID = res.json()['album']['artists'][0]['id']
        #self.features = json.dumps(res.json(), indent=2)


test = song_rec('https://open.spotify.com/track/4fK6E2UywZTJIa5kWnCD6x?si=f6bb7de2dcd24f65', 'dancing', 'morning', 'alt')
test.get_song_artist()
print(test.song_ID, test.artist_ID)
print(test.Night['acousticness'])